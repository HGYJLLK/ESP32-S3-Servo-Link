# ESP32-S3 Show 接线说明

## 硬件清单

- **主控**: ESP32-S3 开发板
- **PWM驱动器**: PCA9685 (16通道, I2C地址 0x40)
- **舵机**:
  - 4个 360度连续旋转舵机 (小力舵机, 通道0-3)
  - 4个 180度标准舵机 (大力舵机, 通道4-7)
- **步进电机**: 5个步进电机 + 驱动器
  - 4个步进电机并联控制 (垂直上下丝杆)
  - 1个步进电机独立控制 (水平左右丝杆)
- **电源**:
  - ESP32-S3: USB供电或外部5V
  - 舵机: 独立5V-6V电源 (大电流)
  - 步进电机: 12V-24V电源 (根据步进电机规格)

---

## 一、ESP32-S3 与 PCA9685 接线

### I2C总线连接

| ESP32-S3 引脚 | PCA9685 引脚 | 说明 |
|--------------|-------------|------|
| GPIO 21      | SDA         | I2C数据线 |
| GPIO 20      | SCL         | I2C时钟线 |
| GND          | GND         | 共地 |
| 3.3V         | VCC         | PCA9685逻辑电源 (3.3V或5V均可) |

**重要**:
- PCA9685的V+引脚需要连接**舵机专用电源**(5V-6V, 至少5A)
- 舵机电源的GND必须与ESP32-S3的GND共地

---

## 二、舵机与 PCA9685 接线

### 360度舵机 (通道0-3, 小力舵机)

| PCA9685通道 | 舵机类型 | 说明 |
|------------|---------|------|
| 0          | 360度小力舵机 | 黄线→PWM0, 红线→V+, 棕线→GND |
| 1          | 360度小力舵机 | 黄线→PWM1, 红线→V+, 棕线→GND |
| 2          | 360度小力舵机 | 黄线→PWM2, 红线→V+, 棕线→GND |
| 3          | 360度小力舵机 | 黄线→PWM3, 红线→V+, 棕线→GND |

### 180度舵机 (通道4-7, 大力舵机)

| PCA9685通道 | 舵机类型 | 说明 |
|------------|---------|------|
| 4          | 180度大力舵机 | 黄线→PWM4, 红线→V+, 棕线→GND |
| 5          | 180度大力舵机 | 黄线→PWM5, 红线→V+, 棕线→GND |
| 6          | 180度大力舵机 | 黄线→PWM6, 红线→V+, 棕线→GND |
| 7          | 180度大力舵机 | 黄线→PWM7, 红线→V+, 棕线→GND |

**舵机线序参考**:
- **黄色/白色/橙色**: PWM信号线
- **红色**: 电源正极 (5V-6V)
- **棕色/黑色**: 电源负极 (GND)

---

## 三、步进电机驱动器接线

### 步进电机驱动器推荐型号
- TB6600 / DM542 / A4988 等常见驱动器
- 支持STEP/DIR控制模式

### 垂直丝杆 (4个步进电机并联)

4个步进电机的驱动器已经由你串联完成，它们共用一组STEP/DIR信号：

| ESP32-S3 引脚 | 驱动器引脚 | 说明 |
|--------------|-----------|------|
| GPIO 1       | STEP+     | 步进脉冲 (4个驱动器并联) |
| GPIO 2       | DIR+      | 方向控制 (4个驱动器并联) |
| GPIO 42      | ENABLE+   | 使能控制 (低电平使能) |
| GND          | STEP-, DIR-, ENABLE- | 信号负极 (共地) |

**重要**:
- 4个驱动器的STEP+引脚全部连接到ESP32的GPIO 1
- 4个驱动器的DIR+引脚全部连接到ESP32的GPIO 2
- 4个驱动器的ENABLE+引脚全部连接到ESP32的GPIO 42
- 所有驱动器的电源GND与ESP32-S3的GND共地

### 水平丝杆 (1个步进电机独立)

| ESP32-S3 引脚 | 驱动器引脚 | 说明 |
|--------------|-----------|------|
| GPIO 41      | STEP+     | 步进脉冲 |
| GPIO 40      | DIR+      | 方向控制 |
| GPIO 39      | ENABLE+   | 使能控制 (低电平使能) |
| GND          | STEP-, DIR-, ENABLE- | 信号负极 (共地) |

---

## 四、步进电机驱动器电源

每个步进电机驱动器需要连接：

| 驱动器引脚 | 连接 | 说明 |
|-----------|-----|------|
| VCC / VM  | 12V-24V电源正极 | 电机电源 (根据步进电机规格选择) |
| GND       | 电源负极 + ESP32 GND | **必须共地** |
| A+, A-    | 步进电机A相 | 连接步进电机线圈A |
| B+, B-    | 步进电机B相 | 连接步进电机线圈B |

**电源配置示例**:
- 如果使用NEMA17步进电机: 12V 2A-3A电源
- 如果使用NEMA23步进电机: 24V 3A-5A电源

---

## 五、完整接线图总结

```
ESP32-S3
├── I2C (GPIO21=SDA, GPIO20=SCL) ──→ PCA9685
│                                    ├── 通道0-3: 360度小力舵机
│                                    └── 通道4-7: 180度大力舵机
│
├── 垂直步进电机 (4个并联)
│   ├── GPIO 1  ──→ STEP+ (4个驱动器并联)
│   ├── GPIO 2  ──→ DIR+  (4个驱动器并联)
│   └── GPIO 42 ──→ ENABLE+ (4个驱动器并联)
│
└── 水平步进电机 (1个独立)
    ├── GPIO 41 ──→ STEP+
    ├── GPIO 40 ──→ DIR+
    └── GPIO 39 ──→ ENABLE+
```

---

## 六、步进电机方向控制说明

### 垂直丝杆 (上下抬起)
- **GPIO 2 = HIGH**: 上升 ↑ (4个丝杆同时上升)
- **GPIO 2 = LOW**: 下降 ↓ (4个丝杆同时下降)

**如果方向相反**, 请修改 [config.h](config.h):
```cpp
// 在stepper_control.ino中反转direction参数
// 或者交换驱动器的DIR+和DIR-接线
```

### 水平丝杆 (左右移动)
- **GPIO 40 = HIGH**: 右移 →
- **GPIO 40 = LOW**: 左移 ←

**如果方向相反**, 可以:
1. 在Web界面中测试方向，看实际运动方向
2. 如果反了，交换驱动器的DIR+和DIR-接线即可

---

## 七、电源系统建议

为了系统稳定运行，推荐使用3个独立电源:

1. **ESP32-S3电源**: USB供电 (5V 500mA) 或独立5V电源
2. **舵机电源**: 5V 5A-10A 开关电源 (8个舵机可能需要较大电流)
3. **步进电机电源**: 12V-24V 10A-20A 开关电源 (5个步进电机)

**关键**: 所有电源的GND必须连接在一起 (共地)

---

## 八、调试步骤

### 1. 上传代码前
- 修改 [config.h](config.h) 中的WiFi账号密码:
  ```cpp
  const char* WIFI_SSID = "你的WiFi名称";
  const char* WIFI_PASSWORD = "你的WiFi密码";
  ```

### 2. Arduino IDE库安装
需要安装以下库 (通过 工具 → 管理库):
- `Adafruit PWM Servo Driver Library`
- `WebSockets` (by Markus Sattler)
- `AccelStepper`

### 3. 测试顺序
1. **先测试I2C通信**: 上传代码后，查看串口监视器，确认PCA9685初始化成功
2. **测试180度舵机**: 在Web界面"180度舵机"页面，逐个测试舵机4-7是否正常
3. **调试360度舵机中点**: 在"360度舵机"页面，使用"调试模式"找到每个舵机的停止角度 (约85-95度之间)
4. **设置360度舵机中点**: 找到中点后，在"中点设置"中保存
5. **测试点动控制**: 点击左右箭头，360度舵机应该短暂旋转后停止
6. **测试步进电机**: 在"步进电机控制"页面，输入小步数 (如100步) 测试方向

### 4. 360度舵机调试技巧
360度舵机的"中点"是让它停止旋转的PWM角度值，不同舵机可能不同:
- 在"调试模式"中，从90度开始测试
- 如果舵机顺时针旋转，减小角度 (如85度)
- 如果舵机逆时针旋转，增大角度 (如95度)
- 找到舵机完全停止的角度，设置为中点

---

## 九、常见问题

**Q: 舵机抖动或不受控?**
- A: 检查舵机电源是否足够 (至少5A), 确认共地连接

**Q: 步进电机不转?**
- A: 检查ENABLE引脚是否为低电平 (使能), 检查驱动器电源电压

**Q: 步进电机方向反了?**
- A: 交换驱动器的DIR+和DIR-接线，或修改代码中的direction符号

**Q: WiFi连接失败?**
- A: 确认WiFi账号密码正确，ESP32-S3只支持2.4GHz频段

**Q: 360度舵机无法停止?**
- A: 使用"调试模式"重新校准中点角度，每个舵机的中点可能不同

---

## 联系与支持

如有问题，请检查串口监视器 (波特率115200) 的输出日志。
Web界面的"运行日志"也会显示详细的操作记录。
